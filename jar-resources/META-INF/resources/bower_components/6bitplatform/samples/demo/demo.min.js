
function initApp(h){var c=false;var u=false;var t=null;var x=0;var r=null;h.on("incomingCall",function(P){console.log("Incoming call",P);G(P);var L=P.invite;var K=L.sender_name?L.sender_name:h.getNameFromIdentity(P.other);var O=L.group_name;var J=P.options.video?" video":"";var N,M;if(typeof O!=="undefined"){N=O.length>0?O:"a group";N="Join "+N+J+" call...";M="Invited by "+K}else{N=K+" is"+J+" calling...";M="Do you dare to answer this call?"}$("#incomingCallFrom").text(N);$("#incomingCallInfo").text(M);$("#incomingCall").data({dialog:P}).show()});h.on("conversation",function(K,J){i(K,J)});h.on("message",function(J,K){j(J,K)});h.on("group",function(J,K){console.log("onGrp",K,J);if(r===J.id){o(J)}});h.on("notification",function(K){console.log("demo got rt notification",K);if(K.type==="typing"){var J=K.to.indexOf("grp:")===0;var L=J?K.to:K.from;if(L===t){I(K.from)}}});h.on("video",function(J,O,N){var K=$("#videoContainer");if(N<0){K[0].removeChild(J)}else{if(N>0){J.setAttribute("class",O?"remote":"local");K.append(J)}}var M=K[0].children.length;if(N!==0){K.toggle(M>0)}console.log("VIDEO elems.count: "+M);var L=M>2?"grid":"simple";K.attr("class",L)});function d(J){$("#authError").html("");var M="usr:"+$("#authUsername").val();var L=$("#authPassword").val();var K=J?"signup":"login";h.session[K]({identity:M,password:L},function(N){if(N){console.log("auth error",N);var O=J?"New user":"Login";O+=": "+N.message;$("#authError").html("<p>"+O+"</p>")}else{console.log("auth done");$("#authUsername").val("");$("#authPassword").val("");A()}});return false}function A(){var J=h.getNameFromIdentity(h.session.identity);h.session.displayName=J;$("#welcome").toggle(false);$("#main").removeClass("hidden");$("#loggedInNavbar").removeClass("hidden");$("#loggedInUser").text(h.session.displayName);a();$("body").removeClass("detail")}function a(){var J=$("#chatList").children();if(J.length>0){console.log("Selecting first chat");J.first().click()}else{console.log("No more chats to select");m(null)}}function i(T,P){var N=$("#chatList");var L=z(T);var X=p(T);var U=$(L);var Q=$(X);if(P<0){if(!T.deleted){console.log("Warning: Deleting a conversation with no deleted property!",T)}if(U.length===0||Q.length===0){console.log("Warning: Deleting a conversation with no DOM element!",T)}U.remove();Q.remove();if(T.id===t){a()}return}if(P>0){if(T.deleted){console.log("Error: Adding a deleted conversation",T);return}if(U.length>0||Q.length>0){console.log("Error: Adding a conversation that has DOM elements!",T)}U=$('<div class="tab" />').attr("id",L.substring(1)).append("<strong />").append("<span />").append("<em />");N.append(U);Q=$('<div class="msgs" />').attr("id",X.substring(1)).hide();$("#msgList").append(Q)}var K=C(T.updated);var R="";var M=T.getLastMessage();if(M){if(M.content){R=M.content}else{if(M.data&&M.data.type){R=M.data.type}}}var W=h.getNameFromIdentity(T.id);if(T.unread>0){W+=" ("+T.unread+")"}U.children("strong").html(W);U.children("span").html(R);U.children("em").html(K);var V=N.children(":first");if(V.length>0){var S=V.attr("id");var J=g(S);var O=h.getConversation(J);if(O&&O.id!==T.id&&T.updated>O.updated){V.before(U)}}if(T.id===t){v()}}function j(W,P){var N=E(W);var T=$(N);if(P<0){console.log("Deleting msg div",W);if(!W.deleted){console.log("Warning: Deleting a message with no deleted property!",W)}if(T.length===0){console.log("Warning: Deleting a message with no DOM element!",W)}T.remove();return}if(P>0){if(W.deleted){console.log("Error: Adding a deleted message",W);return}if(T.length>0){console.log("Error: Adding a message that has a DOM element!",W)}var Q=W.incoming()?"other":"me";T=$('<div class="msg '+Q+'" />').attr("id",N.substring(1));if(W.data&&W.data.type){var aa=W.data.type;var Z=W.data.attach;if(W.data.thumb&&aa.indexOf("audio/")<0){var K=W.data.thumb;T.append('<a class="thumb" href="'+Z+'" target="_new"><img src="'+K+'" /></a>')}else{var O=$('<button class="btn btn-info"/>').text("Play").data("src",Z).click(function(){var ae=$(this).data("src");var ad=new Audio(ae);ad.play()});T.append(O)}}var S=W.content;if(W.isCall()){var R=W.channel();var U=[];if(R&bit6.Message.AUDIO){U.push("Audio")}if(R&bit6.Message.VIDEO){U.push("Video")}if(R&bit6.Message.DATA){if(U.length===0){U.push("Data")}}S=U.join(" + ")+" Call";if(W.data&&W.data.duration){var Y=W.data.duration;var M=Math.floor(Y/60);var L=Y%60;S+=" - "+(M<10?"0":"")+M+":"+(L<10?"0":"")+L}}if(S){T.append("<span>"+S+"</span>")}T.append("<i />");T.append("<em />");var ac=W.getConversationId();var ab=h.getConversation(ac);var J=$(p(ab));J.append(T);if(J.is(":visible")){F();if(W.incoming()){h.markMessageAsRead(W)}I(false)}}var V=C(W.updated);var X;if(W.incoming()){X=h.getNameFromIdentity(W.other)+" "+W.getStatusString()}else{X=B(W)}T.children("i").text(V);T.children("em").text(X)}function I(K){clearInterval(x);if(K){x=setTimeout(function(){$("#msgOtherTyping").toggle(false)},10000);K=h.getNameFromIdentity(K);var J=K+" is typing...";$("#msgOtherTyping").html(J)}$("#msgOtherTyping").toggle(K?true:false)}function B(J){if(!J.incoming()){if(J.status()===bit6.Message.SENDING){if(J.progress&&J.total){var M=""+J.progress;if(J.total>0){var L=Math.floor(J.progress*100/J.total);M=L+"% of "+(J.total<1024?J.total:(J.total>>10)+"k")}return M}}if(J.others){var O=[];for(var K=0;K<J.others.length;K++){var N=J.others[K];if(N.status===bit6.Message.DELIVERED||N.status===bit6.Message.READ){O.push(h.getNameFromIdentity(N.uri)+" "+N.status)}}if(O.length){return O.join(", ")}}}return J.getStatusString()}function C(L){var K=Date.now();var J=24*60*60*1000;var N=new Date(L);var M=(K-L>J)?N.toLocaleDateString():N.toLocaleTimeString();return M}function m(K){console.log("Show messages for",K);if(K!==t){I(false)}t=K;v();if(!K){$("#chatButtons").toggle(false);$("body").removeClass("detail");return}$("body").addClass("detail");var L=h.getConversation(K);if(h.markConversationAsRead(L)>0){console.log("Messages marked as read")}$("#chatButtons").toggle(true);$("#groupInfoButton").toggle(L.isGroup());var J=$(p(L));J.show().siblings().hide();F()}function v(){var K=t;var J="";if(K){var L=h.getConversation(K);J=h.getNameFromIdentity(L.id)}$("#chatTitle").text(J)}function E(J){return"#msg__"+J.domId()}function z(J){return"#tab__"+J.domId()}function p(J){return"#msgs__"+J.domId()}function g(K){var J=K.split("__");K=J.length>0?J[1]:K;return bit6.Conversation.fromDomId(K)}function s(K){var J=K.split("__");K=J.length>0?J[1]:K;return bit6.Message.fromDomId(K)}function F(){var J=$("#msgList");J.scrollTop(J[0].scrollHeight)}function f(){var K=$("#msgText").val();var J=t;if(!K||!J){return}$("#msgText").val("");console.log("Send message to=",J,"content=",K);h.compose(J).text(K).send(function(M,L){console.log("sendMessage result=",L,"err=",M)})}function l(K){for(var J=0,L;L=K[J];J++){console.log(L.name+" - selected - type: "+(L.type||"n/a")+" size: "+L.size+"b");D(L)}}function D(K){var J=t;if(!K||!J){return}console.log("Send attachment to=",J,"file=",K);h.compose(J).attach(K).send(function(M,L){console.log("sendMessage attach result=",L,"err=",M)})}function y(L){var J=L.originalEvent;J.stopPropagation();J.preventDefault();var K=J.dataTransfer.files;l(K)}function w(K){var J=K.originalEvent;J.stopPropagation();J.preventDefault();J.dataTransfer.dropEffect="copy"}function n(O,M,J){var K=u?"mix":"p2p";var L={audio:!c,video:M,screen:J,mode:K};k();var N=h.startCall(O,L);G(N);N.connect();q(N)}function H(K){var J=h.startPhoneCall(K);k();G(J);J.connect();q(J)}function G(J){J.on("progress",function(){b();console.log("CALL progress",J)});J.on("answer",function(){console.log("CALL answered",J)});J.on("error",function(){console.log("CALL error",J)});J.on("end",function(){b();console.log("CALL ended",J);if(h.dialogs.length===0){$("#detailPane").removeClass("hidden");$("#inCallPane").addClass("hidden")}$("#incomingCall").data({dialog:null}).hide()})}function k(){b();$("body").addClass("detail");$("#detailPane").addClass("hidden");$("#inCallPane").removeClass("hidden")}function q(J){b();$("#incallRecord").toggle(J.supports("recording"));$("#incallRecord").toggleClass("active",J.recording());$("#incallVideo").toggleClass("active",J.options.video);$("#incallScreen").toggleClass("active",J.options.screen)}function b(){var K="";for(var J in h.dialogs){var L=h.dialogs[J];if(J>0){K+=", "}K+=h.getNameFromIdentity(L.other)}$("#inCallOther").text(K)}function e(J){r=J.id;o(J);$("#groupInfoModal").modal("show")}function o(N){$("#groupInfoId").text(N.id);$("#groupInfoMe").text(JSON.stringify(N.me));$("#groupInfoMetaRaw").text(JSON.stringify(N.meta,null,2));$("#groupInfoPermsRaw").text(JSON.stringify(N.permissions,null,2));$("#groupInfoMembersRaw").text(JSON.stringify(N.members,null,2));var L=$("#groupInfoMembers").empty();for(var M in N.members){var J=N.members[M];console.log("Member",J);var O=$("<tr/>");O.append("<td>"+J.id+"</td>");O.append("<td>"+J.role+"</td>");O.append("<td>"+(J.status?J.status:"")+"</td>");var K=J.id===N.me.identity?"leave":"kick";if(J.role!=="left"){O.append('<td><a href="#">'+K+"</a></td>")}L.append(O)}}console.log("Bit6 Demo Ready!");$("#msgOtherTyping").toggle(false);$("#incomingCall").toggle(false);$(".dropdown input, .dropdown label").click(function(J){J.stopPropagation()});if(c){$("#inCallAudioDisabled").removeClass("hidden")}$("#loginButton").click(function(){return d(false)});$("#signupButton").click(function(){return d(true)});$("#chatList").on("click",".tab",function(J){var M=$(this).attr("id");var L=g(M);if(h.dialogs.length>0){var K=h.dialogs[0];n(L,K.options.video)}else{m(L)}});$("#backToList").click(function(){$("body").removeClass("detail")});$("#groupInfoModal").on("hidden.bs.modal",function(){r=null});$("#newChatDropdown").on("shown.bs.dropdown",function(){$("#newChatUsername").val("");setTimeout(function(){$("#newChatUsername").focus()},100)});$("#newChatStart").click(function(){var J=$("#newChatUsername").val().trim();console.log("Start chat with"+J);$("body").trigger("click");if(J){if(J.indexOf(":")<0){J="usr:"+J}h.addEmptyConversation(J);m(J)}return false});$("#newGroupCreate").click(function(){var J=$("#newGroupTitle").val().trim();console.log("Create a group with title: "+J);$("body").trigger("click");var K={};if(J){K.meta={title:J}}h.createGroup(K,function(M,L){console.log("Group created",L,M)});return false});$("#newMemberButton").click(function(){var J=$("#newMemberUsername").val().trim();var K=h.getGroup(r);if(J&&K){$("#newMemberUsername").val("");if(J.indexOf(":")<0){J="usr:"+J}h.inviteGroupMember(K,J,"user",function(L){console.log("Member added to group err=",L)})}return false});$("#sendMsgButton").click(function(){console.log("Send message clicked");f()});$("#attachFile").change(function(J){console.log("Attach clicked");var K=J.target.files;l(K)});$("#detailPane").on("dragover",w).on("drop",y);$("#deleteChatButton").click(function(){console.log("Delete current conversation");h.deleteConversation(t,function(J){console.log("Conversation deleted")});return false});$("#groupInfoButton").click(function(){var J=h.getGroup(t);console.log("Show group info for "+t,J);if(J){e(J)}return false});$("#groupInfoMembers").on("click","a",function(N){console.log(N);var L=$(this);var K=L.parents("tr").index();console.log("Removing group member idx",K);var M=h.getGroup(t);if(M){var J=M.members[K];console.log("Removing group member",J);h.kickGroupMember(M,J,function(O){console.log("Member removal result err=",O)})}});$("#mediaModeButton").click(function(){u=!u;$(this).text(u?"Media mode: Mix":"Media mode: P2P")});$("#audioCallButton").click(function(){console.log("Audio call clicked");n(t,false,false)});$("#videoCallDefault").click(function(){n(t,true,false)});$("#videoCallFrontCam").click(function(){var J={facingMode:"user"};n(t,J,false)});$("#videoCallBackCam").click(function(){var J={facingMode:"environment"};n(t,J,false)});$("#screenCallButton").click(function(){console.log("ScreenShare call clicked");n(t,false,true)});$("#phoneCallButton").click(function(){console.log("Phone call clicked");H("+18004663337")});$("#msgText").keydown(function(){console.log("keydown in compose");h.sendTypingNotification(t)});$("#msgText").keyup(function(K){var J=K.which;if(J===13){K.preventDefault();f()}});$("#msgText").on("paste",function(O){var M=[];var J=O.originalEvent;var P=J.clipboardData||{};var K=P.items||[];for(var L=0;L<K.length;L++){var N=K[L].getAsFile();if(N){M.push(N)}}if(M.length>0){J.stopPropagation();J.preventDefault();l(M)}});$("#answerAudio").click(function(){var J=$("#incomingCall").hide();var K=J.data();if(K&&K.dialog){var L=K.dialog;k();L.connect({audio:true,video:false});q(L);J.data({dialog:null})}});$("#answerVideo").click(function(){var J=$("#incomingCall").hide();var K=J.data();if(K&&K.dialog){var L=K.dialog;k();L.connect({audio:true,video:true});q(L);J.data({dialog:null})}});$("#reject").click(function(){var J=$("#incomingCall").hide();var K=J.data();if(K&&K.dialog){K.dialog.hangup();J.data({dialog:null})}});$("#incallRecord").click(function(){var J=h.dialogs.slice();if(J.length>0){var K=J[0];K.recording(!K.recording())}});$("#incallVideo").click(function(){var J=h.dialogs.slice();if(J.length>0){var L=J[0];var K=!L.options.video;L.connect({video:K});q(L)}});$("#incallScreen").click(function(){var J=h.dialogs.slice();if(J.length>0){var L=J[0];var K=!L.options.screen;L.connect({screen:K});q(L)}});$("#hangup").click(function(){$("#detailPane").removeClass("hidden");$("#inCallPane").addClass("hidden");var J=h.dialogs.slice();for(var K in J){console.log("multi-hangup: ",J[K]);J[K].hangup()}});$("#logout").click(function(){t=null;$("#welcome").toggle(true);$("#main").addClass("hidden");$("#loggedInNavbar").addClass("hidden");$("#loggedInUser").text("");$("#chatList").empty();$("#msgList").empty();h.session.logout()})};

 
