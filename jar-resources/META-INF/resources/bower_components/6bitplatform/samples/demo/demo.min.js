function initApp(b6){var disableAudio=false;var useMixMediaMode=false;var currentChatUri=null;var typingLabelTimer=0;var currentGroupId=null;b6.on("incomingCall",function(c){console.log("Incoming call",c);attachCallEvents(c);var i=c.invite;var fromName=i.sender_name?i.sender_name:b6.getNameFromIdentity(c.other);var groupName=i.group_name;var vid=c.options.video?" video":"";var from,info;if(typeof groupName!=="undefined"){from=groupName.length>0?groupName:"a group";from="Join "+from+vid+" call...";info="Invited by "+fromName}else{from=fromName+" is"+vid+" calling...";info="Do you dare to answer this call?"}$("#incomingCallFrom").text(from);$("#incomingCallInfo").text(info);$("#incomingCall").data({dialog:c}).show()});b6.on("conversation",function(c,op){onConversationChange(c,op)});b6.on("message",function(m,op){onMessageChange(m,op)});b6.on("group",function(g,op){console.log("onGrp",op,g);if(currentGroupId===g.id){populateGroupInfoModal(g)}});b6.on("notification",function(m){console.log("demo got rt notification",m);if(m.type==="typing"){var isSentToGroup=m.to.indexOf("grp:")===0;var key=isSentToGroup?m.to:m.from;if(key===currentChatUri){showUserTyping(m.from)}}});b6.on("video",function(v,c,op){var vc=$("#videoContainer");if(op<0){vc[0].removeChild(v)}else if(op>0){v.setAttribute("class",c?"remote":"local");vc.append(v)}var n=vc[0].children.length;if(op!==0){vc.toggle(n>0)}console.log("VIDEO elems.count: "+n);var kl=n>2?"grid":"simple";vc.attr("class",kl)});function authClicked(isNewUser){$("#authError").html("");var ident="usr:"+$("#authUsername").val();var pass=$("#authPassword").val();var fn=isNewUser?"signup":"login";b6.session[fn]({identity:ident,password:pass},function(err){if(err){console.log("auth error",err);var msg=isNewUser?"New user":"Login";msg+=": "+err.message;$("#authError").html("<p>"+msg+"</p>")}else{console.log("auth done");$("#authUsername").val("");$("#authPassword").val("");loginDone()}});return false}function loginDone(){var name=b6.getNameFromIdentity(b6.session.identity);b6.session.displayName=name;$("#welcome").toggle(false);$("#main").removeClass("hidden");$("#loggedInNavbar").removeClass("hidden");$("#loggedInUser").text(b6.session.displayName);selectFirstChat();$("body").removeClass("detail")}function selectFirstChat(){var chats=$("#chatList").children();if(chats.length>0){console.log("Selecting first chat");chats.first().click()}else{console.log("No more chats to select");showChat(null)}}function onConversationChange(c,op){var chatList=$("#chatList");var tabId=tabDomIdForConversation(c);var msgsId=msgsDomIdForConversation(c);var tabDiv=$(tabId);var msgsDiv=$(msgsId);if(op<0){if(!c.deleted){console.log("Warning: Deleting a conversation with no deleted property!",c)}if(tabDiv.length===0||msgsDiv.length===0){console.log("Warning: Deleting a conversation with no DOM element!",c)}tabDiv.remove();msgsDiv.remove();if(c.id===currentChatUri){selectFirstChat()}return}if(op>0){if(c.deleted){console.log("Error: Adding a deleted conversation",c);return}if(tabDiv.length>0||msgsDiv.length>0){console.log("Error: Adding a conversation that has DOM elements!",c)}tabDiv=$('<div class="tab" />').attr("id",tabId.substring(1)).append("<strong />").append("<span />").append("<em />");chatList.append(tabDiv);msgsDiv=$('<div class="msgs" />').attr("id",msgsId.substring(1)).hide();$("#msgList").append(msgsDiv)}var stamp=getRelativeTime(c.updated);var latestText="";var lastMsg=c.getLastMessage();if(lastMsg){if(lastMsg.content){latestText=lastMsg.content}else if(lastMsg.data&&lastMsg.data.type){latestText=lastMsg.data.type}}var title=b6.getNameFromIdentity(c.id);if(c.unread>0){title+=" ("+c.unread+")"}tabDiv.children("strong").html(title);tabDiv.children("span").html(latestText);tabDiv.children("em").html(stamp);var top=chatList.children(":first");if(top.length>0){var topTabId=top.attr("id");var topConvId=domIdToConversationId(topTabId);var topConv=b6.getConversation(topConvId);if(topConv&&topConv.id!==c.id&&c.updated>topConv.updated){top.before(tabDiv)}}if(c.id===currentChatUri){showChatTitle()}}function onMessageChange(m,op){var divId=domIdForMessage(m);var div=$(divId);if(op<0){console.log("Deleting msg div",m);if(!m.deleted){console.log("Warning: Deleting a message with no deleted property!",m)}if(div.length===0){console.log("Warning: Deleting a message with no DOM element!",m)}div.remove();return}if(op>0){if(m.deleted){console.log("Error: Adding a deleted message",m);return}if(div.length>0){console.log("Error: Adding a message that has a DOM element!",m)}var cssClass=m.incoming()?"other":"me";div=$('<div class="msg '+cssClass+'" />').attr("id",divId.substring(1));if(m.data&&m.data.type){var attachType=m.data.type;var href=m.data.attach;if(m.data.thumb&&attachType.indexOf("audio/")<0){var thumbImg=m.data.thumb;div.append('<a class="thumb" href="'+href+'" target="_new"><img src="'+thumbImg+'" /></a>')}else{var btn=$('<button class="btn btn-info"/>').text("Play").data("src",href).click(function(){var src=$(this).data("src");var audio=new Audio(src);audio.play()});div.append(btn)}}var text=m.content;if(m.isCall()){var ch=m.channel();var r=[];if(ch&bit6.Message.AUDIO){r.push("Audio")}if(ch&bit6.Message.VIDEO){r.push("Video")}if(ch&bit6.Message.DATA){if(r.length===0){r.push("Data")}}text=r.join(" + ")+" Call";if(m.data&&m.data.duration){var dur=m.data.duration;var mins=Math.floor(dur/60);var secs=dur%60;text+=" - "+(mins<10?"0":"")+mins+":"+(secs<10?"0":"")+secs}}if(text){div.append("<span>"+text+"</span>")}div.append("<i />");div.append("<em />");var convId=m.getConversationId();var c=b6.getConversation(convId);var msgsDiv=$(msgsDomIdForConversation(c));msgsDiv.append(div);if(msgsDiv.is(":visible")){scrollToLastMessage();if(m.incoming()){b6.markMessageAsRead(m)}showUserTyping(false)}}var stamp=getRelativeTime(m.updated);var status;if(m.incoming()){status=b6.getNameFromIdentity(m.other)+" "+m.getStatusString()}else{status=getMessageStatusString(m)}div.children("i").text(stamp);div.children("em").text(status)}function showUserTyping(ident){clearInterval(typingLabelTimer);if(ident){typingLabelTimer=setTimeout(function(){$("#msgOtherTyping").toggle(false)},1e4);ident=b6.getNameFromIdentity(ident);var txt=ident+" is typing...";$("#msgOtherTyping").html(txt)}$("#msgOtherTyping").toggle(ident?true:false)}function getMessageStatusString(m){if(!m.incoming()){if(m.status()===bit6.Message.SENDING){if(m.progress&&m.total){var s=""+m.progress;if(m.total>0){var perc=Math.floor(m.progress*100/m.total);s=perc+"% of "+(m.total<1024?m.total:(m.total>>10)+"k")}return s}}if(m.others){var d=[];for(var i=0;i<m.others.length;i++){var o=m.others[i];if(o.status===bit6.Message.DELIVERED||o.status===bit6.Message.READ){d.push(b6.getNameFromIdentity(o.uri)+" "+o.status)}}if(d.length){return d.join(", ")}}}return m.getStatusString()}function getRelativeTime(stamp){var now=Date.now();var t24h=24*60*60*1e3;var d=new Date(stamp);var s=now-stamp>t24h?d.toLocaleDateString():d.toLocaleTimeString();return s}function showChat(uri){console.log("Show messages for",uri);if(uri!==currentChatUri){showUserTyping(false)}currentChatUri=uri;showChatTitle();if(!uri){$("#chatButtons").toggle(false);$("body").removeClass("detail");return}$("body").addClass("detail");var conv=b6.getConversation(uri);if(b6.markConversationAsRead(conv)>0){console.log("Messages marked as read")}$("#chatButtons").toggle(true);$("#groupInfoButton").toggle(conv.isGroup());var msgsDiv=$(msgsDomIdForConversation(conv));msgsDiv.show().siblings().hide();scrollToLastMessage()}function showChatTitle(){var uri=currentChatUri;var t="";if(uri){var conv=b6.getConversation(uri);t=b6.getNameFromIdentity(conv.id)}$("#chatTitle").text(t)}function domIdForMessage(m){return"#msg__"+m.domId()}function tabDomIdForConversation(c){return"#tab__"+c.domId()}function msgsDomIdForConversation(c){return"#msgs__"+c.domId()}function domIdToConversationId(id){var r=id.split("__");id=r.length>0?r[1]:id;return bit6.Conversation.fromDomId(id)}function domIdToMessageId(id){var r=id.split("__");id=r.length>0?r[1]:id;return bit6.Message.fromDomId(id)}function scrollToLastMessage(){var t=$("#msgList");t.scrollTop(t[0].scrollHeight)}function sendMessage(){var text=$("#msgText").val();var dest=currentChatUri;if(!text||!dest){return}$("#msgText").val("");console.log("Send message to=",dest,"content=",text);b6.compose(dest).text(text).send(function(err,m){console.log("sendMessage result=",m,"err=",err)})}function handleAttachFiles(files){for(var i=0,f;f=files[i];i++){console.log(f.name+" - selected - type: "+(f.type||"n/a")+" size: "+f.size+"b");handleAttachFile(f)}}function handleAttachFile(f){var dest=currentChatUri;if(!f||!dest){return}console.log("Send attachment to=",dest,"file=",f);b6.compose(dest).attach(f).send(function(err,m){console.log("sendMessage attach result=",m,"err=",err)})}function handleAttachFilesDrop(e){var evt=e.originalEvent;evt.stopPropagation();evt.preventDefault();var files=evt.dataTransfer.files;handleAttachFiles(files)}function handleAttachFilesDragOver(e){var evt=e.originalEvent;evt.stopPropagation();evt.preventDefault();evt.dataTransfer.dropEffect="copy"}function startOutgoingCall(to,video,screen){var mediaMode=useMixMediaMode?"mix":"p2p";var opts={audio:!disableAudio,video:video,screen:screen,mode:mediaMode};prepareInCallUI();var c=b6.startCall(to,opts);attachCallEvents(c);c.connect();updateInCallUI(c)}function startPhoneCall(to){var c=b6.startPhoneCall(to);prepareInCallUI();attachCallEvents(c);c.connect();updateInCallUI(c)}function attachCallEvents(c){c.on("progress",function(){showInCallName();console.log("CALL progress",c)});c.on("answer",function(){console.log("CALL answered",c)});c.on("error",function(){console.log("CALL error",c)});c.on("end",function(){showInCallName();console.log("CALL ended",c);if(b6.dialogs.length===0){$("#detailPane").removeClass("hidden");$("#inCallPane").addClass("hidden")}$("#incomingCall").data({dialog:null}).hide()})}function prepareInCallUI(){showInCallName();$("body").addClass("detail");$("#detailPane").addClass("hidden");$("#inCallPane").removeClass("hidden")}function updateInCallUI(c){showInCallName();$("#incallRecord").toggle(c.supports("recording"));$("#incallRecord").toggleClass("active",c.recording());$("#incallVideo").toggleClass("active",c.options.video);$("#incallScreen").toggleClass("active",c.options.screen)}function showInCallName(){var s="";for(var i in b6.dialogs){var d=b6.dialogs[i];if(i>0){s+=", "}s+=b6.getNameFromIdentity(d.other)}$("#inCallOther").text(s)}function showGroupInfo(g){currentGroupId=g.id;populateGroupInfoModal(g);$("#groupInfoModal").modal("show")}function populateGroupInfoModal(g){$("#groupInfoId").text(g.id);$("#groupInfoMe").text(JSON.stringify(g.me));$("#groupInfoMetaRaw").text(JSON.stringify(g.meta,null,2));$("#groupInfoPermsRaw").text(JSON.stringify(g.permissions,null,2));$("#groupInfoMembersRaw").text(JSON.stringify(g.members,null,2));var tbody=$("#groupInfoMembers").empty();for(var i in g.members){var m=g.members[i];console.log("Member",m);var tr=$("<tr/>");tr.append("<td>"+m.id+"</td>");tr.append("<td>"+m.role+"</td>");tr.append("<td>"+(m.status?m.status:"")+"</td>");var removeMemberLabel=m.id===g.me.identity?"leave":"kick";if(m.role!=="left"){tr.append('<td><a href="#">'+removeMemberLabel+"</a></td>")}tbody.append(tr)}}console.log("Bit6 Demo Ready!");$("#msgOtherTyping").toggle(false);$("#incomingCall").toggle(false);$(".dropdown input, .dropdown label").click(function(e){e.stopPropagation()});if(disableAudio){$("#inCallAudioDisabled").removeClass("hidden")}$("#loginButton").click(function(){return authClicked(false)});$("#signupButton").click(function(){return authClicked(true)});$("#chatList").on("click",".tab",function(e){var id=$(this).attr("id");var convId=domIdToConversationId(id);if(b6.dialogs.length>0){var d=b6.dialogs[0];startOutgoingCall(convId,d.options.video)}else{showChat(convId)}});$("#backToList").click(function(){$("body").removeClass("detail")});$("#groupInfoModal").on("hidden.bs.modal",function(){currentGroupId=null});$("#newChatDropdown").on("shown.bs.dropdown",function(){$("#newChatUsername").val("");setTimeout(function(){$("#newChatUsername").focus()},100)});$("#newChatStart").click(function(){var v=$("#newChatUsername").val().trim();console.log("Start chat with"+v);$("body").trigger("click");if(v){if(v.indexOf(":")<0){v="usr:"+v}b6.addEmptyConversation(v);showChat(v)}return false});$("#newGroupCreate").click(function(){var t=$("#newGroupTitle").val().trim();console.log("Create a group with title: "+t);$("body").trigger("click");var opts={};if(t){opts.meta={title:t}}b6.createGroup(opts,function(err,g){console.log("Group created",g,err)});return false});$("#newMemberButton").click(function(){var v=$("#newMemberUsername").val().trim();var g=b6.getGroup(currentGroupId);if(v&&g){$("#newMemberUsername").val("");if(v.indexOf(":")<0){v="usr:"+v}b6.inviteGroupMember(g,v,"user",function(err){console.log("Member added to group err=",err)})}return false});$("#sendMsgButton").click(function(){console.log("Send message clicked");sendMessage()});$("#attachFile").change(function(evt){console.log("Attach clicked");var files=evt.target.files;handleAttachFiles(files)});$("#detailPane").on("dragover",handleAttachFilesDragOver).on("drop",handleAttachFilesDrop);$("#deleteChatButton").click(function(){console.log("Delete current conversation");b6.deleteConversation(currentChatUri,function(err){console.log("Conversation deleted")});return false});$("#groupInfoButton").click(function(){var g=b6.getGroup(currentChatUri);console.log("Show group info for "+currentChatUri,g);if(g){showGroupInfo(g)}return false});$("#groupInfoMembers").on("click","a",function(e){console.log(e);var t=$(this);var idx=t.parents("tr").index();console.log("Removing group member idx",idx);var g=b6.getGroup(currentChatUri);if(g){var m=g.members[idx];console.log("Removing group member",m);b6.kickGroupMember(g,m,function(err){console.log("Member removal result err=",err)})}});$("#mediaModeButton").click(function(){useMixMediaMode=!useMixMediaMode;$(this).text(useMixMediaMode?"Media mode: Mix":"Media mode: P2P")});$("#audioCallButton").click(function(){console.log("Audio call clicked");startOutgoingCall(currentChatUri,false,false)});$("#videoCallDefault").click(function(){startOutgoingCall(currentChatUri,true,false)});$("#videoCallFrontCam").click(function(){var videoOpt={facingMode:"user"};startOutgoingCall(currentChatUri,videoOpt,false)});$("#videoCallBackCam").click(function(){var videoOpt={facingMode:"environment"};startOutgoingCall(currentChatUri,videoOpt,false)});$("#screenCallButton").click(function(){console.log("ScreenShare call clicked");startOutgoingCall(currentChatUri,false,true)});$("#phoneCallButton").click(function(){console.log("Phone call clicked");startPhoneCall("+18004663337")});$("#msgText").keydown(function(){console.log("keydown in compose");b6.sendTypingNotification(currentChatUri)});$("#msgText").keyup(function(e){var code=e.which;if(code===13){e.preventDefault();sendMessage()}});$("#msgText").on("paste",function(e){var files=[];var evt=e.originalEvent;var clipboardData=evt.clipboardData||{};var items=clipboardData.items||[];for(var i=0;i<items.length;i++){var f=items[i].getAsFile();if(f){files.push(f)}}if(files.length>0){evt.stopPropagation();evt.preventDefault();handleAttachFiles(files)}});$("#answerAudio").click(function(){var e=$("#incomingCall").hide();var d=e.data();if(d&&d.dialog){var c=d.dialog;prepareInCallUI();c.connect({audio:true,video:false});updateInCallUI(c);e.data({dialog:null})}});$("#answerVideo").click(function(){var e=$("#incomingCall").hide();var d=e.data();if(d&&d.dialog){var c=d.dialog;prepareInCallUI();c.connect({audio:true,video:true});updateInCallUI(c);e.data({dialog:null})}});$("#reject").click(function(){var e=$("#incomingCall").hide();var d=e.data();if(d&&d.dialog){d.dialog.hangup();e.data({dialog:null})}});$("#incallRecord").click(function(){var x=b6.dialogs.slice();if(x.length>0){var c=x[0];c.recording(!c.recording())}});$("#incallVideo").click(function(){var x=b6.dialogs.slice();if(x.length>0){var c=x[0];var t=!c.options.video;c.connect({video:t});updateInCallUI(c)}});$("#incallScreen").click(function(){var x=b6.dialogs.slice();if(x.length>0){var c=x[0];var t=!c.options.screen;c.connect({screen:t});updateInCallUI(c)}});$("#hangup").click(function(){$("#detailPane").removeClass("hidden");$("#inCallPane").addClass("hidden");var x=b6.dialogs.slice();for(var i in x){console.log("multi-hangup: ",x[i]);x[i].hangup()}});$("#logout").click(function(){currentChatUri=null;$("#welcome").toggle(true);$("#main").addClass("hidden");$("#loggedInNavbar").addClass("hidden");$("#loggedInUser").text("");$("#chatList").empty();$("#msgList").empty();b6.session.logout()})}