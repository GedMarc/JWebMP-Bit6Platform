
function initApp(e){e.on("incomingCall",function(l){console.log("Incoming call",l);j(l);$("#incomingCallFrom").text(e.getNameFromIdentity(l.other)+" is connecting...");$("#incomingCall").data({dialog:l}).show()});e.on("notification",function(l){console.log("demo got rt notification",l)});function f(l){var p=function(q){if(q){console.log("auth error",q);var r=l;r+=": "+q.message;$("#authError").html("<p>"+r+"</p>")}else{console.log("auth done");$("#authUsername").val("");$("#authPassword").val("");b()}};$("#authError").html("");if(l==="login"||l==="signup"){var o="usr:"+$("#authUsername").val();var n=$("#authPassword").val();var m={identity:o,password:n};e.session[l](m,p)}else{e.session[l](p)}return false}function b(){$("#welcome").toggle(false);$("#main").removeClass("hidden");$("#loggedInNavbar").removeClass("hidden");$(".loggedInUser").text(e.getNameFromIdentity(e.session.identity));$(".loggedInIdent").text(e.session.identity)}function g(n){$("#incall").toggle(true);$("#connect").toggle(false);var l={audio:false,video:false,data:true};var m=e.startCall(n,l);if(m){j(m);$("#other").text(n);m.connect()}}function j(l){l.on("progress",function(){console.log("CALL progress",l)});l.on("answer",function(){console.log("CALL answered",l)});l.on("error",function(){console.log("CALL error",l)});l.on("end",function(){console.log("CALL ended",l);if(e.dialogs.length===0){$("#incall").toggle(false);$("#connect").toggle(true)}$("#incomingCall").data({dialog:null}).hide()});l.on("transfer",function(t){var r=t.outgoing?"send":"recv";$("#"+r+"Name").text(t.info.name);var q=t.percentage()+"%";var m=e.dialogs[0].rtc.dc;if(m&&m.bufferedAmount){q+=" - buf: "+m.bufferedAmount}$("#"+r+"Status").text(q);if(t.completed()){q=t.info.name+" - ";q+=t.outgoing?"SENT":"RECEIVED";c(q);if(!t.outgoing){var n=new Blob([t.data],t.info);var o=window.URL.createObjectURL(n);var p=null;if(t.info.type.indexOf("image")>=0){p=$('<img src="'+o+'" alt="'+t.info.name+'"/>')}else{p=$("<span>"+t.info.name+"</span>")}$("#recvImgs").append(p);p[0].onclick=function(){var s=document.createElement("a");s.href=o;s.download=t.info.name;s.click()}}}})}function h(m){for(var l=0,n;n=m[l];l++){c(n.name+" - selected - type: "+(n.type||"n/a")+" size: "+n.size+"b");e.dialogs[0].sendFile(n)}}function a(l){var m=l.target.files;h(m)}function k(n){var l=n.originalEvent;l.stopPropagation();l.preventDefault();var m=l.dataTransfer.files;h(m)}function d(m){var l=m.originalEvent;l.stopPropagation();l.preventDefault();l.dataTransfer.dropEffect="copy"}function c(m){var n=$("#log");var l=n.html();n.html(m+"<br>\n"+l)}console.log("FT Demo Ready!");$("#files").change(a);var i=$("#dropzone");i.on("dragover",function(l){d(l)});i.on("drop",function(l){k(l)});$("#incomingCall").toggle(false);$("#incall").toggle(false);$("#loginButton").click(function(){return f("login")});$("#signupButton").click(function(){return f("signup")});$("#anonButton").click(function(){return f("anonymous")});$("#connectButton").click(function(){var m=$("#dest").val();if(m){if(m.indexOf(":")<0){m=e.session.identity.split(":")[0]+":"+m}var l=g(m)}return false});$("#dest").keyup(function(m){var l=m.which;if(l===13){m.preventDefault();$("#connectButton").click()}});$("#clearReceived").click(function(){$("#recvImgs").html("");$("#log").html("")});$("#answer").click(function(){var l=$("#incomingCall").hide();var m=l.data();if(m&&m.dialog){var n=m.dialog;$("#incall").toggle(true);$("#connect").toggle(false);$("#other").text(n.other);n.connect();l.data({dialog:null})}});$("#reject").click(function(){var l=$("#incomingCall").hide();var m=l.data();if(m&&m.dialog){m.dialog.hangup();l.data({dialog:null})}});$("#hangup").click(function(){var l=e.dialogs.slice();for(var m in l){console.log("multi-hangup: ",l[m]);l[m].hangup()}});$("#logout").click(function(){$("#welcome").toggle(true);$("#main").addClass("hidden");$("#loggedInNavbar").addClass("hidden");$(".loggedInUser").text("");$(".loggedInIdent").text("");$("#clearReceived").click();e.session.logout()})};

 
